<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ficha de Atendimento (F.A.) v2.2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos CSS completos para a página */
        :root {
            --primary-color: #5856d6;
            --danger-color: #ff3b30;
            --background-color: #f2f2f7;
            --card-background: #ffffff;
            --text-color: #1c1c1e;
            --label-color: #6c6c70;
            --border-color: #e5e5ea;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        header p {
            color: var(--label-color);
            font-size: 1rem;
        }

        main {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 2rem;
            align-items: flex-start;
        }

        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .form-container, .history-container {
            background-color: var(--card-background);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .form-container h2, .history-container h2 {
            margin-top: 0;
            margin-bottom: 2rem;
            font-size: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0 0 1.5rem 0;
        }

        fieldset legend {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--label-color);
            margin-bottom: 0.5rem;
        }

        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: #fcfcfc;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(88, 86, 214, 0.15);
        }

        .grid-2-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3-cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }

        .btn {
            width: 100%;
            padding: 1rem;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #4a48b9; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #d90429; }
        .btn-secondary { background-color: #e5e5ea; color: var(--text-color); }
        .btn-secondary:hover { background-color: #d1d1d6; }
        .btn:disabled { background-color: #c7c7cc; cursor: not-allowed; }

        .history-list-content { min-height: 400px; display: flex; flex-direction: column; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--label-color); flex-grow: 1; padding: 1rem; }
        .empty-state svg { color: #d1d1d6; margin-bottom: 1rem; }
        .empty-state p { font-weight: 500; margin: 0; font-size: 1rem; }
        .empty-state span { font-size: 0.875rem; }

        .history-item {
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .history-item:hover { border-color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .history-item-header h4 { margin: 0; font-size: 1rem; color: var(--text-color); }
        .history-item-body p { margin: 0; font-size: 0.875rem; color: var(--label-color); line-height: 1.5; }
        .history-item-body strong { color: var(--text-color); font-weight: 500; }
        .btn-delete { background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--label-color); }
        .btn-delete:hover { color: var(--danger-color); }

        /* Estilos do Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body p { margin: 0 0 1rem 0; line-height: 1.6; }
        .modal-body strong { color: var(--text-color); }
        .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        
        #prescription-history { border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto; margin-bottom: 1.5rem; }
        .prescription-entry { padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 1px dashed var(--border-color); }
        .prescription-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .prescription-entry-meta { font-size: 0.8rem; color: var(--label-color); margin-bottom: 0.25rem; }
        .prescription-entry-text { font-size: 0.95rem; white-space: pre-wrap; }

        #confirmation-modal .modal-content { max-width: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sistema de Ficha de Atendimento (F.A.)</h1>
            <p>Gerencie os atendimentos de forma rápida e eficiente.</p>
        </header>
        <main>
            <div class="form-container">
                <h2>Nova Ficha de Atendimento</h2>
                <form id="form-atendimento">
                    <fieldset>
                        <legend>1. Identificação do Paciente</legend>
                        <div class="input-group"><label for="id-atendimento">N° Ficha / ID do Atendimento</label><input type="text" id="id-atendimento" required></div>
                        <div class="input-group"><label for="nome-completo">Nome Completo</label><input type="text" id="nome-completo" required></div>
                        <div class="input-group"><label for="data-nascimento">Data de Nascimento</label><input type="date" id="data-nascimento" required></div>
                    </fieldset>
                    <fieldset id="fieldset-datetime">
                        <legend>2. Data e Hora</legend>
                        <div class="grid-2-cols">
                            <div class="input-group"><label for="data-atendimento">Data do Atendimento</label><input type="date" id="data-atendimento" required></div>
                            <div class="input-group"><label for="hora-atendimento">Hora do Atendimento</label><input type="time" id="hora-atendimento" required></div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>3. Sinais Vitais</legend>
                        <div class="grid-3-cols">
                            <div class="input-group"><label for="pa">PA (mmHg)</label><input type="text" id="pa"></div>
                            <div class="input-group"><label for="fc">FC (bpm)</label><input type="number" id="fc"></div>
                            <div class="input-group"><label for="hgt">HGT (mg/dL)</label><input type="number" id="hgt"></div>
                            <div class="input-group"><label for="temp">Temp (°C)</label><input type="number" step="0.1" id="temp"></div>
                            <div class="input-group"><label for="spo2">SpO₂ (%)</label><input type="number" id="spo2"></div>
                            <div class="input-group"><label for="dor">Dor (0-10)</label><input type="number" id="dor"></div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>4. Anamnese</legend>
                        <div class="input-group"><label for="anamnese">Sintomas / Queixa Principal</label><textarea id="anamnese" rows="4"></textarea></div>
                    </fieldset>
                    <button type="submit" id="btn-salvar" class="btn btn-primary">Salvar Ficha</button>
                </form>
            </div>
            <div class="history-container">
                 <h2>Histórico de Atendimentos</h2>
                 <div id="history-list" class="history-list-content"></div>
            </div>
        </main>
    </div>

    <!-- Modal de Prescrição -->
    <div id="prescription-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-patient-name"></h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Anamnese:</strong> <span id="modal-anamnese"></span></p>
                <label>Histórico de Evolução</label>
                <div id="prescription-history"></div>
                <div class="input-group">
                    <label for="prescricao-textarea">Adicionar Nova Evolução</label>
                    <textarea id="prescricao-textarea" rows="6"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close-btn">Cancelar</button>
                <button id="modal-save-btn" class="btn btn-primary">Adicionar Evolução</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Confirmar Exclusão</h3></div>
            <div class="modal-body"><p>Você tem certeza que deseja excluir esta ficha? Esta ação não pode ser desfeita.</p></div>
            <div class="modal-footer">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-delete-btn" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- 1. CONFIGURAÇÃO ---
        const SUPABASE_URL = 'https://thfzovvghzkjoabcmyze.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoZnpvdnZnaHpram9hYmNteXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NDgzODgsImV4cCI6MjA3MDUyNDM4OH0.U5JEZ78sLFU80Wt5SADG4scdoIKacNbqawgVJh5X5wA';
        const supabase = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. SELETORES DO DOM ---
        const formAtendimento = document.getElementById('form-atendimento');
        const historyList = document.getElementById('history-list');
        const submitButton = document.getElementById('btn-salvar');
        const dataAtendimentoInput = document.getElementById('data-atendimento');
        const horaAtendimentoInput = document.getElementById('hora-atendimento');
        
        const prescriptionModal = document.getElementById('prescription-modal');
        const modalPatientName = document.getElementById('modal-patient-name');
        const modalAnamnese = document.getElementById('modal-anamnese');
        const prescriptionHistoryDiv = document.getElementById('prescription-history');
        const prescricaoTextarea = document.getElementById('prescricao-textarea');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCloseBtns = document.querySelectorAll('.modal-close-btn');

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        // --- 3. FUNÇÕES ---

        function setDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            dataAtendimentoInput.value = date;
            horaAtendimentoInput.value = time;
        }

        async function carregarHistorico() {
            const { data: atendimentos, error } = await supabase.from('atendimentos').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Erro ao carregar histórico:', error); return; }
            
            historyList.innerHTML = '';
            if (atendimentos && atendimentos.length > 0) {
                atendimentos.forEach(atendimento => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'history-item';
                    itemDiv.dataset.id = atendimento.id;

                    const vitals = [
                        { label: 'PA', value: atendimento.pa }, { label: 'FC', value: atendimento.fc },
                        { label: 'HGT', value: atendimento.hgt }, { label: 'Temp', value: atendimento.temp },
                        { label: 'SpO₂', value: atendimento.spo2 }, { label: 'Dor', value: atendimento.dor }
                    ].filter(v => v.value != null && v.value !== '').map(v => `<strong>${v.label}:</strong> ${v.value}`).join(' | ');

                    itemDiv.innerHTML = `
                        <div class="history-item-header">
                            <h4>${atendimento.nome_paciente || 'Paciente não informado'}</h4>
                            <button class="btn-delete" data-id="${atendimento.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>
                        </div>
                        <div class="history-item-body">
                            <p><strong>ID:</strong> ${atendimento.id_atendimento || 'N/A'} | <strong>Data:</strong> ${new Date(atendimento.data_atendimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                            <p>${vitals}</p>
                        </div>
                    `;
                    
                    itemDiv.addEventListener('click', (e) => { if (!e.target.closest('.btn-delete')) openPrescriptionModal(atendimento); });
                    itemDiv.querySelector('.btn-delete').addEventListener('click', (e) => { e.stopPropagation(); openConfirmationModal(atendimento.id); });
                    historyList.appendChild(itemDiv);
                });
            } else {
                historyList.innerHTML = `<div class="empty-state"><p>Nenhuma ficha de atendimento encontrada.</p></div>`;
            }
        }

        async function salvarFicha(event) {
            event.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            const dadosFicha = {
                id_atendimento: document.getElementById('id-atendimento').value,
                nome_paciente: document.getElementById('nome-completo').value,
                data_nascimento: document.getElementById('data-nascimento').value,
                data_atendimento: dataAtendimentoInput.value,
                hora_atendimento: horaAtendimentoInput.value,
                pa: document.getElementById('pa').value,
                fc: parseInt(document.getElementById('fc').value) || null,
                hgt: parseInt(document.getElementById('hgt').value) || null,
                temp: parseFloat(document.getElementById('temp').value) || null,
                spo2: parseInt(document.getElementById('spo2').value) || null,
                dor: parseInt(document.getElementById('dor').value) || null,
                anamnese: document.getElementById('anamnese').value,
            };

            const { error } = await supabase.from('atendimentos').insert([dadosFicha]);
            if (error) { console.error('Erro ao salvar ficha:', error); alert('Ocorreu um erro ao salvar a ficha.'); } 
            else { formAtendimento.reset(); setDateTime(); await carregarHistorico(); }
            submitButton.disabled = false;
            submitButton.textContent = 'Salvar Ficha';
        }

        function openPrescriptionModal(atendimento) {
            modalPatientName.textContent = `Evolução de ${atendimento.nome_paciente}`;
            modalAnamnese.textContent = atendimento.anamnese || 'Nenhuma.';
            
            prescriptionHistoryDiv.innerHTML = '';
            const entries = atendimento.prescricao || [];
            if (entries.length > 0) {
                // Mostra as entradas em ordem cronológica (mais antiga primeiro)
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'prescription-entry';
                    const entryDate = new Date(entry.timestamp);
                    const formattedDate = `${entryDate.toLocaleDateString('pt-BR')} às ${entryDate.toLocaleTimeString('pt-BR')}`;
                    entryDiv.innerHTML = `<div class="prescription-entry-meta">${formattedDate}</div><div class="prescription-entry-text">${entry.text}</div>`;
                    prescriptionHistoryDiv.appendChild(entryDiv);
                });
            } else {
                prescriptionHistoryDiv.innerHTML = '<p style="text-align:center; color: var(--label-color);">Nenhuma evolução registrada.</p>';
            }

            prescricaoTextarea.value = '';
            modalSaveBtn.dataset.id = atendimento.id;
            modalSaveBtn.dataset.currentPrescription = JSON.stringify(entries);
            prescriptionModal.style.display = 'flex';
        }

        function closeAllModals() {
            prescriptionModal.style.display = 'none';
            confirmationModal.style.display = 'none';
        }

        async function savePrescription() {
            const id = modalSaveBtn.dataset.id;
            const newText = prescricaoTextarea.value.trim();
            if (!newText) { alert('Por favor, insira um texto para a nova evolução.'); return; }

            const existingEntries = JSON.parse(modalSaveBtn.dataset.currentPrescription || '[]');
            
            const newEntry = {
                timestamp: new Date().toISOString(),
                text: newText
            };
            existingEntries.push(newEntry);

            const { error } = await supabase.from('atendimentos').update({ prescricao: existingEntries }).eq('id', id);
            if (error) { console.error('Erro ao salvar prescrição:', error); alert('Não foi possível salvar a prescrição.'); } 
            else { closeAllModals(); await carregarHistorico(); }
        }

        function openConfirmationModal(id) {
            confirmDeleteBtn.dataset.id = id;
            confirmationModal.style.display = 'flex';
        }

        async function deleteAtendimento() {
            const id = confirmDeleteBtn.dataset.id;
            const { error } = await supabase.from('atendimentos').delete().eq('id', id);
            if (error) { console.error('Erro ao excluir:', error); alert('Não foi possível excluir a ficha.'); } 
            else { closeAllModals(); await carregarHistorico(); }
        }

        // --- 4. EVENT LISTENERS ---
        formAtendimento.addEventListener('submit', salvarFicha);
        modalSaveBtn.addEventListener('click', savePrescription);
        confirmDeleteBtn.addEventListener('click', deleteAtendimento);
        confirmCancelBtn.addEventListener('click', closeAllModals);
        modalCloseBtns.forEach(btn => btn.addEventListener('click', closeAllModals));
        
        document.addEventListener('DOMContentLoaded', () => {
            setDateTime();
            carregarHistorico();
        });
    </script>
</body>
</html>
